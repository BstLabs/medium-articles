# How to Convert Pure Python Functions to User-friendly CLI

This story is based on the article [How to Write User-friendly Command Line Interfaces in Python](https://towardsdatascience.com/how-to-write-user-friendly-command-line-interfaces-in-python-cc3a6444af8e)

In original article following Python libraries were shown for building a *vaccination QR code* for you : argparse, Click, Typer, Docopt, Fire.

We want to extend this article by using [dynacli](https://pypi.org/project/dynacli/).
There is fair enough comparison between libraries [DynaCLI vs. Alternatives](https://bstlabs.github.io/py-dynacli/advanced/why/).

## What are we building?

The core concept behind our changes is to ease down the process of building CLI applications by focusing only on Python code itself.
To keep it simple dynacli generates help messages from the Python function docstrings and the function arguments are converted to CLI commands.

Sounds interesting? Let's start.

The starter code grabbed from the original [article]((https://towardsdatascience.com/how-to-write-user-friendly-command-line-interfaces-in-python-cc3a6444af8e)):

```py
from dataclasses import dataclass, field, asdict
import requests
import shutil
from datetime import datetime

class ValidationException(Exception):
    pass

@dataclass
class Vaccination:
    manufacturer: str
    date: str

    def __post_init__(self):
        try:
            date = datetime.strptime(self.date, "%Y-%m-%d")
        except Exception:
            raise ValidationException("Vaccination date should be in format YYYY-MM-DD.")
        if date > datetime.today():
            raise ValidationException("Vaccination date should not be a future date.")
        if self.manufacturer.lower() not in ["pfizer","moderna","astrazeneca","janssen","sinovac"]:
            raise ValidationException("Your vaccine manufacturer is not approved.")

@dataclass
class QRCode:
    name: str
    birth: str
    vaccine: list[Vaccination] = field(default_factory=list)

def generate_qr_code(qr_code):
    code = asdict(qr_code)
    res = requests.get(f"http://api.qrserver.com/v1/create-qr-code/?data={code}", stream=True)
    if res.status_code == 200:
        with open("qr_code.png", "wb") as f:
            res.raw.decode_content = True
            shutil.copyfileobj(res.raw, f)
        return "QR code has been generated."
    else:
        raise Exception("QR code cannot be generated by QR Code Generator API.")
```

Then you need to generate build CLI for eg, using argparse, again shown in original article:

```py
def main():
    parser = argparse.ArgumentParser(description="Generate your vaccination QR code.")
    parser.add_argument("-n", "--name", type=str, help="Your name", required=True)
    parser.add_argument("-b", "--birth", type=str, help="Your birthday in YYYY-MM-DD format", required=True)
    parser.add_argument("-m", "--manufacturer", type=str, nargs="+", help="The vaccine manufacturer", required=True, choices=[
            "pfizer","moderna","astrazeneca","janssen","sinovac"])
    parser.add_argument("-d", "--date", type=str, nargs="+", help="The date of vaccination", required=True)
    args = parser.parse_args()
    
    if len(args.manufacturer) != len(args.date):
        logging.error(
            "The number of vaccine manufacturer doesn't match with the number of vaccine dates."
        )
        exit(1)
    
    qr_code = QRCode(name=args.name, birth=args.birth, vaccine=[Vaccination(args.manufacturer[i], args.date[i]) for i in range(len(args.date))])
    generate_qr_code(qr_code)

if __name__ == "__main__":
    try:
        main()
    except ValidationException as e:
        logging.error(e)
    except Exception as e:
        logging.exception(e)
```

Building CLIs in general divided in 2 steps: first the core code and second the CLI itself predefined as set of arguments, as shown above.

With [dynacli](https://pypi.org/project/dynacli/) we can skip 2nd part by designing our functions to be CLI-friendly.

## Our changes to the original code

First off all, we would like to restructure the CLI - thinking about CLI there should be `./qr-code` then `green-badge` feature-set(actual Python package) it is for storing all commands,
then `generate` to generate actual QR codes:

```sh
$ tree green_badge -I __pycache__

green_badge
├── generate.py
└── __init__.py

```

Returning back to original code, if you notice, the Vaccine manufacturers are limited set of companies and those kind of information is a best fit for `Enum` type:

```py
from enum import Enum

class Manufacturer(Enum):
    pfizer = 1
    moderna = 2
    astrazeneca = 3
    janssen = 4
    sinovac = 5

```

Or we can use [Literal](https://docs.python.org/3.9/library/typing.html#typing.Literal) -  and I am going to use it here in favor of Enum, by that we lose some guard but the clean interface is always beats and you can always add extra checks outside of the interface.

Therefore, we do not need manufacturer check in the `__post_init__` anymore and can remove it, going further, the whole purpose of `@dataclass` here, is the validation, we can replace them with [TypedDict](https://docs.python.org/3.9/library/typing.html#typing.TypedDict).

Our updated code `generate.py` file looks like:

```py
class Vaccination(TypedDict):
    date: datetime
    manufacturer: Literal["pfizer", "moderna", "astrazeneca", "janssen", "sinovac"]


class QRCode(TypedDict):
    name: str
    birth: str
    vaccination: list[Vaccination]
```

The second big step is to design actual `generate` function in a way that it is going to accept all necessary information as arguments:

```py
def generate(first_name: str, last_name: str, birthdate: str,  **vaccination: str) -> None:
    """
    Generate your vaccination QR code.

    Args:
        first_name (str): name of the vaccinated person
        last_name (str): surname of the vaccindate person
        birthdate (str): birthday of the vaccinated person in YYYY-MM-DD format
        **vaccination (str): vaccination information as date=manufacturer 

    Return: None
    """
    qr_code = QRCode(
        name=f"{first_name} {last_name}",
        birth=birthdate,
        vaccination=[
            Vaccination(manufacturer=manufacturer, date=datetime.strptime(date, "%Y-%m-%d"))
            for date, manufacturer in vaccination.items()
        ],
    )
    res = requests.get(
        f"http://api.qrserver.com/v1/create-qr-code/?data={qr_code}", stream=True
    )
    if res.status_code != 200:
        raise Exception("QR code cannot be generated by QR Code Generator API.")
    with open("qr_code.png", "wb") as f:
        res.raw.decode_content = True
        shutil.copyfileobj(res.raw, f)
    print("QR code has been generated.")
```

The big change is we are going to accept date and the manufacturer name as keyword arguments.
This is quite intuitive isn't it? Thinking about CLI call, it will look like: `./qr-code green-badge generate Shako Rzayev 1989-10-24 2021-01-01=pfizer 2021-06-01=pfizer`

The next important change is - we have docstring with explanation of the arguments - you are right, dynacli uses this for building the help messages of the CLI.
Again quite Pythonic - we already added explanation, why register same help message for building the CLI?

The rest of the code is mostly the same - functionally no change, the logic is the same.

## CLI entrypoint

Now just last step, create CLI entrypoint with dynacli, create a file called `cli` and add following:

```py
#!/usr/bin/env python3

"""
Sample QR Generator
"""

import os
import sys

cwd = os.path.dirname(os.path.realpath(__file__))

__version__ = '1.0'

from dynacli import main

search_path = [cwd]
sys.path.extend(search_path)

main(search_path)
```

As you have already noticed, again there is no CLI pre-processing, adding arguments, version callback etc.
Everything is dead simple Python. DynaCLI grabs version from `__version__` and CLI name from cli docstring.

And that is it, now are ready to run the CLI, just give the execution priveleges to this file:

```sh
$ chmod u+x qr-code
```

Getting help output:

```sh
$ ./qr-code -h

usage: qr-code [-h] [-v] {green-badge} ...

Sample QR Generator

positional arguments:
  {green-badge}
    green-badge  Generate Green Badge

optional arguments:
  -h, --help     show this help message and exit
  -v, --version  show program's version number and exit
```

The `green-badge` help message comes from the package `__init__.py` file:

```sh
$ cat green_badge/__init__.py 

"""
Generate Green Badge
"""

__version__ = "2.0"
```

Getting the version of the CLI itself:

```sh
$ ./qr-code --version

qr-code - v1.0
```

Now let's think about different situation - imagine your are porting some already developed package to be exposed by CLI,
and it has own version v2.0 - should it mess up with our CLI version? We do not want to be sticked with only single version.

Nope, you can version your packages and even modules with DynaCLI - again it is Pythonic just add `__version__` to package `__init__.py` and to the `generate.py` module itself.

```sh
$ ./qr-code green-badge --version

qr-code green-badge - v2.0
```

```sh
$ /qr-code green-badge generate --version

qr-code green-badge generate - v3.0
```

DynaCLI detects `generate.py` file and it has `generate` function in it, and yes only public names will be exposed by CLI.
If you recall this function has a docstring - yes, that is the help message registered from function docstring.

Here, we want to stress the bullet point - with DynaCLI no need to begin write things from the scratch and rewrite the whole code base.
All you need to import already existing functionality to some intermediate representation as we did with `generate.py` and register it in the CLI.
This effectively conforms the [Open/Closed Principle](https://en.wikipedia.org/wiki/Open%E2%80%93closed_principle) - 
your original code is closed to modification but is open to be extended by CLI.

Our final version of `generate.py` looks like:

```py
import shutil
from datetime import datetime
from typing import Literal, TypedDict

import requests

__version__ = "3.0"

class Vaccination(TypedDict):
    date: datetime
    manufacturer: Literal["pfizer", "moderna", "astrazeneca", "janssen", "sinovac"]


class QRCode(TypedDict):
    name: str
    birth: str
    vaccination: list[Vaccination]


def generate(first_name: str, last_name: str, birthdate: str,  **vaccination: str) -> None:
    """
    Generate your vaccination QR code.

    Args:
        first_name (str): name of the vaccinated person
        last_name (str): surname of the vaccindate person
        birthdate (str): birthday of the vaccinated person in YYYY-MM-DD format
        **vaccination (str): vaccination information as date=manufacturer 

    Return: None
    """
    qr_code = QRCode(
        name=f"{first_name} {last_name}",
        birth=birthdate,
        vaccination=[
            Vaccination(manufacturer=manufacturer, date=datetime.strptime(date, "%Y-%m-%d"))
            for date, manufacturer in vaccination.items()
        ],
    )
    res = requests.get(
        f"http://api.qrserver.com/v1/create-qr-code/?data={qr_code}", stream=True
    )
    if res.status_code != 200:
        raise Exception("QR code cannot be generated by QR Code Generator API.")
    with open("qr_code.png", "wb") as f:
        res.raw.decode_content = True
        shutil.copyfileobj(res.raw, f)
    print("QR code has been generated.")
```

You can get help about actual command:

```py
$ ./qr-code green-badge generate -h
usage: qr-code green-badge generate [-h] first_name last_name birthdate [vaccination <name>=<value> ...]

positional arguments:
  first_name            name of the vaccinated person
  last_name             surname of the vaccindate person
  birthdate             birthday of the vaccinated person in YYYY-MM-DD format
  vaccination <name>=<value>
                        vaccination information as date=manufacturer

optional arguments:
  -h, --help            show this help message and exit
```

Wait, we did not added or registered any help messages - no need they are grabbed from function docstring.

DynaCLI detects `**kwargs` and registers it as `<name>=<value>` pair.

Now it is time to run our actual final command(function):

```sh
$ ./qr-code green-badge generate Shako Rzayev 1989-10-24 2021-01-01=pfizer 2021-06-01=pfizer

QR code has been generated.
```

![QR](./code/qr_code.png)

That's it. We have focused only to the core functionality, cleaned it up a bit, reshaped it to be CLI friendly - and that is how the CLIs should be.
You only enjoy your Python code, nothing more.
